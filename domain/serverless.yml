# Defines resources for the domain used for APIs
service: ${file(../config.cjs):config.serviceName}-domain
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${file(../config.cjs):config.stage}
  region: ${file(../config.cjs):config.region}

plugins:
  - serverless-iam-roles-per-function

custom:
  domainName: ${file(../config.cjs):config.domain}
  apiDomainName: api.${self:custom.domainName}
  domainHostedZoneId: ${ssm(us-east-1):/weshare/${sls:stage}/domainHostedZone}

resources:
  Resources:
    DomainCert:
      Type: AWS::CertificateManager::Certificate
      Properties:
        DomainName: ${self:custom.apiDomainName}
        ValidationMethod: DNS
        DomainValidationOptions:
          - DomainName: ${self:custom.apiDomainName}
            HostedZoneId: ${self:custom.domainHostedZoneId}

    ApiCustomDomain:
      Type: AWS::ApiGatewayV2::DomainName
      Properties:
        DomainName: ${self:custom.apiDomainName}
        DomainNameConfigurations:
          - CertificateArn: !Ref DomainCert

    DomainRecordSet:
      Type: AWS::Route53::RecordSetGroup
      Properties:
        HostedZoneId: ${self:custom.domainHostedZoneId}
        RecordSets:
          - Name: ${self:custom.apiDomainName}
            Type: A
            AliasTarget:
              DNSName: !GetAtt ApiCustomDomain.RegionalDomainName
              HostedZoneId: !GetAtt ApiCustomDomain.RegionalHostedZoneId
          - Name: ${self:custom.apiDomainName}
            Type: AAAA
            AliasTarget:
              DNSName: !GetAtt ApiCustomDomain.RegionalDomainName
              HostedZoneId: !GetAtt ApiCustomDomain.RegionalHostedZoneId